#!/usr/bin/env python2
#-*- python -*-

from charmhelpers import (
    get_config,
    log,
    log_entry,
    log_exit,
    open_port,
)

from utils import (
    start_agent,
    start_gui,
    start_improv,
)


def open_ports(juju_api_port):
    """Expose Juju GUI web server and websocket server ports."""
    log('Exposing services.')
    # Open the Juju GUI web server HTTP and HTTPS ports.
    open_port(80)
    # Uncomment to switch back to TLS connections.
    open_port(443)
    # Open the Juju websocket server port.
    open_port(juju_api_port)


def main():
    config = get_config()
    juju_api_port = config['juju-api-port']
    staging = config.get('staging')
    start_gui(
        juju_api_port, config['juju-gui-console-enabled'], staging,
        config['ssl-cert-path'])
    if staging:
        start_improv(juju_api_port, ssl_cert_path=config['ssl-cert-path'],
            config_path=config['staging-environment'])
    else:
        start_agent(juju_api_port, ssl_cert_path=config['ssl-cert-path'])
    open_ports(juju_api_port)


if __name__ == '__main__':
    log_entry()
    try:
        main()
    finally:
        log_exit()
