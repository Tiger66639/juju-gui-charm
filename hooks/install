#!/usr/bin/env python2
# -*- python -*-

import json
import os

# If the user's environment has "juju-origin: ppa" set, they will
# automatically have access to python-charmhelpers and python-shelltoolbox.
# However, we want to support environments that use the non-PPA environment as
# well.  To do so, we need to install the Juju PPA, which we will do with a
# couple of functions that are actually maintained in python-shelltoolbox.
import bootstrap_utils


def get_config():
    output = bootstrap_utils.run('config-get', '--format', 'json')
    return json.loads(output)

config = get_config()
allow_repos = config.get('allow-additional-deb-repositories', True)
if allow_repos:
    bootstrap_utils.install_extra_repositories('ppa:juju/pkgs')

# Python dependencies must be installed here so that the charm can import and
# use required libraries.
PYTHON_DEPENDENCIES = (
    'python-apt', 'python-charmhelpers', 'python-launchpadlib',
    'python-shelltoolbox', 'python-tempita',
)
bootstrap_utils.run(*(('apt-get', 'install', '-y') + PYTHON_DEPENDENCIES))


from utils import (
    config_json,
    log_hook,
)

from backend import Backend


def main():
    # Run pre-install tasks, if available.  Please do not rely on the
    # exec.d interface without conferring with the Juju GUI team: it may
    # change after upcoming discussion with Canonical IS.
    if os.path.isdir('exec.d'):
        for module in os.listdir('exec.d'):
            try:
                bootstrap_utils.run(os.path.join('exec.d',module,'charm-pre-install'))
            except OSError:
                pass
    config = get_config()
    backend = Backend(config)
    backend.install()
    # Store current configuration.
    config_json.set(config)


if __name__ == '__main__':
    with log_hook():
        main()
