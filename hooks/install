#!/usr/bin/env python2
# -*- python -*-

from subprocess import (
    CalledProcessError,
    check_call,
)

# python-shelltoolbox is installed as a dependency of python-charmhelpers.
check_call(['apt-get', 'install', '-y', 'python-charmhelpers'])


# These modules depend on charmhelpers and shelltoolbox being installed so they
# must not be imported until those packages are available.
from charmhelpers import (
    get_config,
    log,
    log_entry,
    log_exit,
)
from shelltoolbox import (
    apt_get_install,
    install_extra_repositories,
)

from utils import (
    cmd_log,
    config_json,
    fetch_api,
    fetch_gui,
    setup_gui,
    setup_nginx,
)


DEB_DEPENDENCIES = (
    'bzr', 'imagemagick', 'make', 'nginx', 'nodejs', 'npm', 'openssl',
    'python-launchpadlib', 'zookeeper',
)


def get_dependencies():
    log('Installing dependencies.')
    cmd_log(install_extra_repositories('ppa:chris-lea/node.js'))
    cmd_log(apt_get_install(*DEB_DEPENDENCIES))


def main():
    config = get_config()
    get_dependencies()
    release_tarball = fetch_gui(
        config['juju-gui-source'], config['command-log-file'])
    setup_gui(release_tarball)
    setup_nginx(config['ssl-cert-path'])
    fetch_api(config['juju-api-branch'])
    config_json.set(config)


if __name__ == '__main__':
    log_entry()
    try:
        main()
    except CalledProcessError as e:
        log('Exception caught:')
        log(e.output)
        raise
    finally:
        log_exit()
